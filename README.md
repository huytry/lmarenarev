<<<<<<< Current (Your changes)
# lmarenarev

=======
# ðŸš€ LMArena Bridge - æ–°ä¸€ä»£ OpenAI æ¡¥æŽ¥å™¨ ðŸŒ‰

æ¬¢è¿Žæ¥åˆ°æ–°ä¸€ä»£çš„ LMArena Bridgeï¼ðŸŽ‰ è¿™æ˜¯ä¸€ä¸ªåŸºäºŽ FastAPI å’Œ WebSocket çš„é«˜æ€§èƒ½å·¥å…·é›†ï¼Œå®ƒèƒ½è®©ä½ é€šè¿‡ä»»ä½•å…¼å®¹ OpenAI API çš„å®¢æˆ·ç«¯æˆ–åº”ç”¨ç¨‹åºï¼Œæ— ç¼ä½¿ç”¨ [LMArena.ai](https://lmarena.ai/) å¹³å°ä¸Šæä¾›çš„æµ·é‡å¤§è¯­è¨€æ¨¡åž‹ã€‚

è¿™ä¸ªé‡æž„ç‰ˆæœ¬æ—¨åœ¨æä¾›æ›´ç¨³å®šã€æ›´æ˜“äºŽç»´æŠ¤å’Œæ‰©å±•çš„ä½“éªŒã€‚

## âœ¨ ä¸»è¦åŠŸèƒ½

*   **ðŸš€ é«˜æ€§èƒ½åŽç«¯**: åŸºäºŽ **FastAPI** å’Œ **Uvicorn**ï¼Œæä¾›å¼‚æ­¥ã€é«˜æ€§èƒ½çš„ API æœåŠ¡ã€‚
*   **ðŸ”Œ ç¨³å®šçš„ WebSocket é€šä¿¡**: ä½¿ç”¨ WebSocket æ›¿ä»£ Server-Sent Events (SSE)ï¼Œå®žçŽ°æ›´å¯é ã€ä½Žå»¶è¿Ÿçš„åŒå‘é€šä¿¡ã€‚
*   **ðŸ¤– OpenAI å…¼å®¹æŽ¥å£**: å®Œå…¨å…¼å®¹ OpenAI `v1/chat/completions`ã€`v1/models` ä»¥åŠ `v1/images/generations` ç«¯ç‚¹ã€‚
*   **ðŸ“‹ æ‰‹åŠ¨æ¨¡åž‹åˆ—è¡¨æ›´æ–°**: æ–°å¢ž `model_updater.py` è„šæœ¬ï¼Œå¯æ‰‹åŠ¨è§¦å‘ä»Ž LMArena é¡µé¢æå–æœ€æ–°çš„å¯ç”¨æ¨¡åž‹åˆ—è¡¨ï¼Œå¹¶ä¿å­˜ä¸º `available_models.json`ï¼Œæ–¹ä¾¿æŸ¥é˜…å’Œæ›´æ–°æ ¸å¿ƒçš„ `models.json`ã€‚
*   **ðŸ“Ž é€šç”¨æ–‡ä»¶ä¸Šä¼ **: æ”¯æŒé€šè¿‡ Base64 ä¸Šä¼ ä»»æ„ç±»åž‹çš„æ–‡ä»¶ï¼ˆå›¾ç‰‡ã€éŸ³é¢‘ã€PDFã€ä»£ç ç­‰ï¼‰ï¼Œå¹¶æ”¯æŒä¸€æ¬¡æ€§ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ã€‚
*   **ðŸŽ¨ æ–‡ç”Ÿå›¾æ”¯æŒ**: æ–°å¢žæ–‡ç”Ÿå›¾åŠŸèƒ½ï¼Œå¯é€šè¿‡æ ‡å‡† OpenAI æŽ¥å£è°ƒç”¨ LMArena çš„å›¾åƒç”Ÿæˆæ¨¡åž‹ã€‚
*   **ðŸ—£ï¸ å®Œæ•´å¯¹è¯åŽ†å²æ”¯æŒ**: è‡ªåŠ¨å°†ä¼šè¯åŽ†å²æ³¨å…¥åˆ° LMArenaï¼Œå®žçŽ°æœ‰ä¸Šä¸‹æ–‡çš„è¿žç»­å¯¹è¯ã€‚
*   **ðŸŒŠ å®žæ—¶æµå¼å“åº”**: åƒåŽŸç”Ÿ OpenAI API ä¸€æ ·ï¼Œå®žæ—¶æŽ¥æ”¶æ¥è‡ªæ¨¡åž‹çš„æ–‡æœ¬å›žåº”ã€‚
*   **ðŸ”„ è‡ªåŠ¨ç¨‹åºæ›´æ–°**: å¯åŠ¨æ—¶è‡ªåŠ¨æ£€æŸ¥ GitHub ä»“åº“ï¼Œå‘çŽ°æ–°ç‰ˆæœ¬æ—¶å¯è‡ªåŠ¨ä¸‹è½½å¹¶æ›´æ–°ç¨‹åºã€‚
*   **ðŸ†” ä¸€é”®å¼ä¼šè¯IDæ›´æ–°**: æä¾› `id_updater.py` è„šæœ¬ï¼Œåªéœ€åœ¨æµè§ˆå™¨æ“ä½œä¸€æ¬¡ï¼Œå³å¯è‡ªåŠ¨æ•èŽ·å¹¶æ›´æ–° `config.jsonc` ä¸­æ‰€éœ€çš„ä¼šè¯ IDã€‚
*   **âš™ï¸ æµè§ˆå™¨è‡ªåŠ¨åŒ–**: é…å¥—çš„æ²¹çŒ´è„šæœ¬ (`LMArenaApiBridge.js`) è´Ÿè´£ä¸ŽåŽç«¯æœåŠ¡å™¨é€šä¿¡ï¼Œå¹¶åœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œæ‰€æœ‰å¿…è¦æ“ä½œã€‚
*   **ðŸ» é…’é¦†æ¨¡å¼ (Tavern Mode)**: ä¸“ä¸º SillyTavern ç­‰åº”ç”¨è®¾è®¡ï¼Œæ™ºèƒ½åˆå¹¶ `system` æç¤ºè¯ï¼Œç¡®ä¿å…¼å®¹æ€§ã€‚
*   **ðŸ¤« Bypass æ¨¡å¼**: å°è¯•é€šè¿‡åœ¨è¯·æ±‚ä¸­é¢å¤–æ³¨å…¥ä¸€ä¸ªç©ºçš„ç”¨æˆ·æ¶ˆæ¯ï¼Œç»•è¿‡å¹³å°çš„æ•æ„Ÿè¯å®¡æŸ¥ã€‚
*   **ðŸ” API Key ä¿æŠ¤**: å¯åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® API Keyï¼Œä¸ºä½ çš„æœåŠ¡å¢žåŠ ä¸€å±‚å®‰å…¨ä¿éšœã€‚
*   **ðŸŽ¯ æ¨¡åž‹-ä¼šè¯é«˜çº§æ˜ å°„**: æ”¯æŒä¸ºä¸åŒæ¨¡åž‹é…ç½®ç‹¬ç«‹çš„ä¼šè¯IDæ± ï¼Œå¹¶èƒ½ä¸ºæ¯ä¸ªä¼šè¯æŒ‡å®šç‰¹å®šçš„å·¥ä½œæ¨¡å¼ï¼ˆå¦‚ `battle` æˆ– `direct_chat`ï¼‰ï¼Œå®žçŽ°æ›´ç²¾ç»†çš„è¯·æ±‚æŽ§åˆ¶ã€‚

## âš™ï¸ é…ç½®æ–‡ä»¶è¯´æ˜Ž

é¡¹ç›®çš„ä¸»è¦è¡Œä¸ºé€šè¿‡ `config.jsonc`, `models.json` å’Œ `model_endpoint_map.json` è¿›è¡ŒæŽ§åˆ¶ã€‚

### `models.json` - æ ¸å¿ƒæ¨¡åž‹æ˜ å°„
è¿™ä¸ªæ–‡ä»¶åŒ…å«äº† LMArena å¹³å°ä¸Šçš„æ¨¡åž‹åç§°åˆ°å…¶å†…éƒ¨IDçš„æ˜ å°„ã€‚
*   **é‡è¦**: è¿™æ˜¯ç¨‹åºè¿è¡Œæ‰€**å¿…éœ€**çš„æ ¸å¿ƒæ–‡ä»¶ã€‚ä½ éœ€è¦æ‰‹åŠ¨ç»´æŠ¤è¿™ä¸ªåˆ—è¡¨ï¼Œç¡®ä¿å…¶ä¸­åŒ…å«ä½ å¸Œæœ›é€šè¿‡APIä½¿ç”¨çš„æ¨¡åž‹ã€‚
*   å½“å®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ªæ¨¡åž‹æ—¶ï¼Œ`api_server.py` ä¼šåœ¨æ­¤æ–‡ä»¶ä¸­æŸ¥æ‰¾å¯¹åº”çš„æ¨¡åž‹IDã€‚

### `available_models.json` - å¯ç”¨æ¨¡åž‹å‚è€ƒ (å¯é€‰)
*   è¿™æ˜¯ä¸€ä¸ª**å‚è€ƒæ–‡ä»¶**ï¼Œç”±æ–°å¢žçš„ `model_updater.py` è„šæœ¬ç”Ÿæˆã€‚
*   å®ƒåŒ…å«äº†ä»Ž LMArena é¡µé¢ä¸Šæå–çš„æ‰€æœ‰æ¨¡åž‹çš„å®Œæ•´ä¿¡æ¯ï¼ˆID, åç§°, ç»„ç»‡ç­‰ï¼‰ã€‚
*   ä½ å¯ä»¥è¿è¡Œ `model_updater.py` æ¥ç”Ÿæˆæˆ–æ›´æ–°æ­¤æ–‡ä»¶ï¼Œç„¶åŽä»Žä¸­å¤åˆ¶ä½ éœ€è¦ä½¿ç”¨çš„æ¨¡åž‹ä¿¡æ¯åˆ° `models.json` ä¸­ã€‚

### `config.jsonc` - å…¨å±€é…ç½®

è¿™æ˜¯ä¸»è¦çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«äº†æœåŠ¡å™¨çš„å…¨å±€è®¾ç½®ã€‚

*   `session_id` / `message_id`: å…¨å±€é»˜è®¤çš„ä¼šè¯IDã€‚å½“æ¨¡åž‹æ²¡æœ‰åœ¨ `model_endpoint_map.json` ä¸­æ‰¾åˆ°ç‰¹å®šæ˜ å°„æ—¶ï¼Œä¼šä½¿ç”¨è¿™é‡Œçš„IDã€‚
*   `id_updater_last_mode` / `id_updater_battle_target`: å…¨å±€é»˜è®¤çš„è¯·æ±‚æ¨¡å¼ã€‚åŒæ ·ï¼Œå½“ç‰¹å®šä¼šè¯æ²¡æœ‰æŒ‡å®šæ¨¡å¼æ—¶ï¼Œä¼šä½¿ç”¨è¿™é‡Œçš„è®¾ç½®ã€‚
*   `use_default_ids_if_mapping_not_found`: ä¸€ä¸ªéžå¸¸é‡è¦çš„å¼€å…³ï¼ˆé»˜è®¤ä¸º `true`ï¼‰ã€‚
    *   `true`: å¦‚æžœè¯·æ±‚çš„æ¨¡åž‹åœ¨ `model_endpoint_map.json` ä¸­æ‰¾ä¸åˆ°ï¼Œå°±ä½¿ç”¨å…¨å±€é»˜è®¤çš„IDå’Œæ¨¡å¼ã€‚
    *   `false`: å¦‚æžœæ‰¾ä¸åˆ°æ˜ å°„ï¼Œåˆ™ç›´æŽ¥è¿”å›žé”™è¯¯ã€‚è¿™åœ¨ä½ éœ€è¦ä¸¥æ ¼æŽ§åˆ¶æ¯ä¸ªæ¨¡åž‹çš„ä¼šè¯æ—¶éžå¸¸æœ‰ç”¨ã€‚
*   å…¶ä»–é…ç½®é¡¹å¦‚ `api_key`, `tavern_mode_enabled` ç­‰ï¼Œè¯·å‚è€ƒæ–‡ä»¶å†…çš„æ³¨é‡Šã€‚

### `model_endpoint_map.json` - æ¨¡åž‹ä¸“å±žé…ç½®

è¿™æ˜¯ä¸€ä¸ªå¼ºå¤§çš„é«˜çº§åŠŸèƒ½ï¼Œå…è®¸ä½ è¦†ç›–å…¨å±€é…ç½®ï¼Œä¸ºç‰¹å®šçš„æ¨¡åž‹è®¾ç½®ä¸€ä¸ªæˆ–å¤šä¸ªä¸“å±žçš„ä¼šè¯ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**:
1.  **ä¼šè¯éš”ç¦»**: ä¸ºä¸åŒçš„æ¨¡åž‹ä½¿ç”¨ç‹¬ç«‹çš„ä¼šè¯ï¼Œé¿å…ä¸Šä¸‹æ–‡ä¸²æ‰°ã€‚
2.  **æé«˜å¹¶å‘**: ä¸ºçƒ­é—¨æ¨¡åž‹é…ç½®ä¸€ä¸ªIDæ± ï¼Œç¨‹åºä¼šåœ¨æ¯æ¬¡è¯·æ±‚æ—¶éšæœºé€‰æ‹©ä¸€ä¸ªIDä½¿ç”¨ï¼Œæ¨¡æ‹Ÿè½®è¯¢ï¼Œå‡å°‘å•ä¸ªä¼šè¯è¢«é¢‘ç¹è¯·æ±‚çš„é£Žé™©ã€‚
3.  **æ¨¡å¼ç»‘å®š**: å°†ä¸€ä¸ªä¼šè¯IDä¸Žå®ƒè¢«æ•èŽ·æ—¶çš„æ¨¡å¼ï¼ˆ`direct_chat` æˆ– `battle`ï¼‰ç»‘å®šï¼Œç¡®ä¿è¯·æ±‚æ ¼å¼æ°¸è¿œæ­£ç¡®ã€‚

**é…ç½®ç¤ºä¾‹**:
```json
{
  "claude-3-opus-20240229": [
    {
      "session_id": "session_for_direct_chat_1",
      "message_id": "message_for_direct_chat_1",
      "mode": "direct_chat"
    },
    {
      "session_id": "session_for_battle_A",
      "message_id": "message_for_battle_A",
      "mode": "battle",
      "battle_target": "A"
    }
  ],
  "gemini-1.5-pro-20241022": {
      "session_id": "single_session_id_no_mode",
      "message_id": "single_message_id_no_mode"
  }
}
```
*   **Opus**: é…ç½®äº†ä¸€ä¸ªIDæ± ã€‚è¯·æ±‚æ—¶ä¼šéšæœºé€‰æ‹©å…¶ä¸­ä¸€ä¸ªï¼Œå¹¶ä¸¥æ ¼æŒ‰ç…§å…¶ç»‘å®šçš„ `mode` å’Œ `battle_target` æ¥å‘é€è¯·æ±‚ã€‚
*   **Gemini**: ä½¿ç”¨äº†å•ä¸ªIDå¯¹è±¡ï¼ˆæ—§æ ¼å¼ï¼Œä¾ç„¶å…¼å®¹ï¼‰ã€‚ç”±äºŽå®ƒæ²¡æœ‰æŒ‡å®š `mode`ï¼Œç¨‹åºä¼šè‡ªåŠ¨ä½¿ç”¨ `config.jsonc` ä¸­å®šä¹‰çš„å…¨å±€æ¨¡å¼ã€‚

## ðŸ› ï¸ å®‰è£…ä¸Žä½¿ç”¨

ä½ éœ€è¦å‡†å¤‡å¥½ Python çŽ¯å¢ƒå’Œä¸€æ¬¾æ”¯æŒæ²¹çŒ´è„šæœ¬çš„æµè§ˆå™¨ (å¦‚ Chrome, Firefox, Edge)ã€‚

### 1. å‡†å¤‡å·¥ä½œ

*   **å®‰è£… Python ä¾èµ–**
    æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥é¡¹ç›®æ ¹ç›®å½•ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
    ```bash
    pip install -r requirements.txt
    ```

*   **å®‰è£…æ²¹çŒ´è„šæœ¬ç®¡ç†å™¨**
    ä¸ºä½ çš„æµè§ˆå™¨å®‰è£… [Tampermonkey](https://www.tampermonkey.net/) æ‰©å±•ã€‚

*   **å®‰è£…æœ¬é¡¹ç›®æ²¹çŒ´è„šæœ¬**
    1.  æ‰“å¼€ Tampermonkey æ‰©å±•çš„ç®¡ç†é¢æ¿ã€‚
    2.  ç‚¹å‡»â€œæ·»åŠ æ–°è„šæœ¬â€æˆ–â€œCreate a new scriptâ€ã€‚
    3.  å°† [`TampermonkeyScript/LMArenaApiBridge.js`](TampermonkeyScript/LMArenaApiBridge.js) æ–‡ä»¶ä¸­çš„æ‰€æœ‰ä»£ç å¤åˆ¶å¹¶ç²˜è´´åˆ°ç¼–è¾‘å™¨ä¸­ã€‚
    4.  ä¿å­˜è„šæœ¬ã€‚

### 2. è¿è¡Œä¸»ç¨‹åº

1.  **å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨**
    åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œè¿è¡Œä¸»æœåŠ¡ç¨‹åºï¼š
    ```bash
    python api_server.py
    ```
    å½“ä½ çœ‹åˆ°æœåŠ¡å™¨åœ¨ `http://127.0.0.1:5102` å¯åŠ¨çš„æç¤ºæ—¶ï¼Œè¡¨ç¤ºæœåŠ¡å™¨å·²å‡†å¤‡å°±ç»ªã€‚

2.  **ä¿æŒ LMArena é¡µé¢å¼€å¯**
    ç¡®ä¿ä½ è‡³å°‘æœ‰ä¸€ä¸ª LMArena é¡µé¢æ˜¯æ‰“å¼€çš„ï¼Œå¹¶ä¸”æ²¹çŒ´è„šæœ¬å·²æˆåŠŸè¿žæŽ¥åˆ°æœ¬åœ°æœåŠ¡å™¨ï¼ˆé¡µé¢æ ‡é¢˜ä¼šä»¥ `âœ…` å¼€å¤´ï¼‰ã€‚è¿™é‡Œæ— éœ€ä¿æŒåœ¨å¯¹è¯é¡µé¢ï¼Œåªè¦æ˜¯åŸŸåä¸‹çš„é¡µé¢éƒ½å¯ä»¥LeaderBoardéƒ½å¯ä»¥ã€‚

### 3. æ›´æ–°å¯ç”¨æ¨¡åž‹åˆ—è¡¨ (å¯é€‰ï¼Œä½†æŽ¨è)
æ­¤æ­¥éª¤ä¼šç”Ÿæˆ `available_models.json` æ–‡ä»¶ï¼Œè®©ä½ çŸ¥é“å½“å‰ LMArena ä¸Šæœ‰å“ªäº›å¯ç”¨çš„æ¨¡åž‹ï¼Œæ–¹ä¾¿ä½ æ›´æ–° `models.json`ã€‚
1.  **ç¡®ä¿ä¸»æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ**ã€‚
2.  æ‰“å¼€**ä¸€ä¸ªæ–°çš„ç»ˆç«¯**ï¼Œè¿è¡Œæ¨¡åž‹æ›´æ–°å™¨ï¼š
    ```bash
    python model_updater.py
    ```
3.  è„šæœ¬ä¼šè‡ªåŠ¨è¯·æ±‚æµè§ˆå™¨æŠ“å–æ¨¡åž‹åˆ—è¡¨ï¼Œå¹¶åœ¨æ ¹ç›®å½•ç”Ÿæˆ `available_models.json` æ–‡ä»¶ã€‚
4.  æ‰“å¼€ `available_models.json`ï¼Œæ‰¾åˆ°ä½ æƒ³è¦çš„æ¨¡åž‹ï¼Œå°†å…¶ `"publicName"` å’Œ `"id"` é”®å€¼å¯¹å¤åˆ¶åˆ° `models.json` æ–‡ä»¶ä¸­ï¼ˆæ ¼å¼ä¸º `"publicName": "id"`ï¼‰ã€‚

### 4. é…ç½®ä¼šè¯ ID (éœ€è¦æ—¶ï¼Œä¸€èˆ¬åªé…ç½®ä¸€æ¬¡å³å¯ï¼Œé™¤éžåˆ‡æ¢æ¨¡åž‹æˆ–è€…åŽŸå¯¹è¯å¤±æ•ˆ)

è¿™æ˜¯**æœ€é‡è¦**çš„ä¸€æ­¥ã€‚ä½ éœ€è¦èŽ·å–ä¸€ä¸ªæœ‰æ•ˆçš„ä¼šè¯ ID å’Œæ¶ˆæ¯ IDï¼Œä»¥ä¾¿ç¨‹åºèƒ½å¤Ÿæ­£ç¡®åœ°ä¸Ž LMArena API é€šä¿¡ã€‚

1.  **ç¡®ä¿ä¸»æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ**
    `api_server.py` å¿…é¡»å¤„äºŽè¿è¡ŒçŠ¶æ€ï¼Œå› ä¸º ID æ›´æ–°å™¨éœ€è¦é€šè¿‡å®ƒæ¥æ¿€æ´»æµè§ˆå™¨çš„æ•èŽ·åŠŸèƒ½ã€‚

2.  **è¿è¡Œ ID æ›´æ–°å™¨**
    æ‰“å¼€**ä¸€ä¸ªæ–°çš„ç»ˆç«¯**ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œ `id_updater.py` è„šæœ¬ï¼š
    ```bash
    python id_updater.py
    ```
    *   è„šæœ¬ä¼šæç¤ºä½ é€‰æ‹©æ¨¡å¼ (DirectChat / Battle)ã€‚
    *   é€‰æ‹©åŽï¼Œå®ƒä¼šé€šçŸ¥æ­£åœ¨è¿è¡Œçš„ä¸»æœåŠ¡å™¨ã€‚

3.  **æ¿€æ´»ä¸Žæ•èŽ·**
    *   æ­¤æ—¶ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°æµè§ˆå™¨ä¸­ LMArena é¡µé¢çš„æ ‡é¢˜æ æœ€å‰é¢å‡ºçŽ°äº†ä¸€ä¸ªå‡†æ˜Ÿå›¾æ ‡ (ðŸŽ¯)ï¼Œè¿™è¡¨ç¤º**IDæ•èŽ·æ¨¡å¼å·²æ¿€æ´»**ã€‚
    *   åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä¸€ä¸ª LMArena ç«žæŠ€åœºçš„ **ç›®æ ‡æ¨¡åž‹å‘é€ç»™æ¶ˆæ¯çš„é¡µé¢**ã€‚è¯·æ³¨æ„ï¼Œå¦‚æžœæ˜¯Battleé¡µé¢ï¼Œè¯·ä¸è¦æŸ¥çœ‹æ¨¡åž‹åç§°ï¼Œä¿æŒåŒ¿åçŠ¶æ€ï¼Œå¹¶ä¿è¯å½“å‰æ¶ˆæ¯ç•Œé¢çš„æœ€åŽä¸€æ¡æ˜¯ç›®æ ‡æ¨¡åž‹çš„ä¸€ä¸ªå›žç­”ï¼›å¦‚æžœæ˜¯Direct Chatï¼Œè¯·ä¿è¯å½“å‰æ¶ˆæ¯ç•Œé¢çš„æœ€åŽä¸€æ¡æ˜¯ç›®æ ‡æ¨¡åž‹çš„ä¸€ä¸ªå›žç­”ã€‚
    *   **ç‚¹å‡»ç›®æ ‡æ¨¡åž‹çš„å›žç­”å¡ç‰‡å³ä¸Šè§’çš„é‡è¯•ï¼ˆRetryï¼‰æŒ‰é’®**ã€‚
    *   æ²¹çŒ´è„šæœ¬ä¼šæ•èŽ·åˆ° `sessionId` å’Œ `messageId`ï¼Œå¹¶å°†å…¶å‘é€ç»™ `id_updater.py`ã€‚

4.  **éªŒè¯ç»“æžœ**
    *   å›žåˆ°ä½ è¿è¡Œ `id_updater.py` çš„ç»ˆç«¯ï¼Œä½ ä¼šçœ‹åˆ°å®ƒæ‰“å°å‡ºæˆåŠŸæ•èŽ·åˆ°çš„ IDï¼Œå¹¶æç¤ºå·²å°†å…¶å†™å…¥ `config.jsonc` æ–‡ä»¶ã€‚
    *   è„šæœ¬åœ¨æˆåŠŸåŽä¼šè‡ªåŠ¨å…³é—­ã€‚çŽ°åœ¨ä½ çš„é…ç½®å·²å®Œæˆï¼

### 5. é…ç½®ä½ çš„ OpenAI å®¢æˆ·ç«¯
å°†ä½ çš„å®¢æˆ·ç«¯æˆ–åº”ç”¨çš„ OpenAI API åœ°å€æŒ‡å‘æœ¬åœ°æœåŠ¡å™¨ï¼š
*   **API Base URL**: `http://127.0.0.1:5102/v1`
*   **API Key**: å¦‚æžœ `config.jsonc` ä¸­çš„ `api_key` ä¸ºç©ºï¼Œåˆ™å¯éšä¾¿è¾“å…¥ï¼›å¦‚æžœå·²è®¾ç½®ï¼Œåˆ™å¿…é¡»æä¾›æ­£ç¡®çš„ Keyã€‚
*   **Model Name**: åœ¨ä½ çš„å®¢æˆ·ç«¯ä¸­æŒ‡å®šä½ æƒ³ä½¿ç”¨çš„æ¨¡åž‹åç§°ï¼ˆ**å¿…é¡»ä¸Ž `models.json` ä¸­çš„åç§°å®Œå…¨åŒ¹é…**ï¼‰ã€‚æœåŠ¡å™¨ä¼šæ ¹æ®è¿™ä¸ªåç§°æŸ¥æ‰¾å¯¹åº”çš„æ¨¡åž‹IDã€‚

### 6. å¼€å§‹èŠå¤©ï¼ ðŸ’¬
çŽ°åœ¨ä½ å¯ä»¥æ­£å¸¸ä½¿ç”¨ä½ çš„å®¢æˆ·ç«¯äº†ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šé€šè¿‡æœ¬åœ°æœåŠ¡å™¨ä»£ç†åˆ° LMArena ä¸Šï¼

## ðŸ¤” å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

è¿™ä¸ªé¡¹ç›®ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šä¸€ä¸ªæœ¬åœ° Python **FastAPI** æœåŠ¡å™¨å’Œä¸€ä¸ªåœ¨æµè§ˆå™¨ä¸­è¿è¡Œçš„**æ²¹çŒ´è„šæœ¬**ã€‚å®ƒä»¬é€šè¿‡ **WebSocket** ååŒå·¥ä½œã€‚

```mermaid
sequenceDiagram
    participant C as OpenAI å®¢æˆ·ç«¯ ðŸ’»
    participant S as æœ¬åœ° FastAPI æœåŠ¡å™¨ ðŸ
    participant MU as æ¨¡åž‹æ›´æ–°è„šæœ¬ (model_updater.py) ðŸ“‹
    participant IU as ID æ›´æ–°è„šæœ¬ (id_updater.py) ðŸ†”
    participant T as æ²¹çŒ´è„šæœ¬ ðŸµ (åœ¨ LMArena é¡µé¢)
    participant L as LMArena.ai ðŸŒ

    alt åˆå§‹åŒ–
        T->>+S: (é¡µé¢åŠ è½½) å»ºç«‹ WebSocket è¿žæŽ¥
        S-->>-T: ç¡®è®¤è¿žæŽ¥
    end

    alt æ‰‹åŠ¨æ›´æ–°æ¨¡åž‹åˆ—è¡¨ (å¯é€‰)
        MU->>+S: (ç”¨æˆ·è¿è¡Œ) POST /internal/request_model_update
        S->>T: (WebSocket) å‘é€ 'send_page_source' æŒ‡ä»¤
        T->>T: æŠ“å–é¡µé¢ HTML
        T->>S: (HTTP) POST /internal/update_available_models (å«HTML)
        S->>S: è§£æžHTMLå¹¶ä¿å­˜åˆ° available_models.json
        S-->>-MU: ç¡®è®¤
    end

    alt æ‰‹åŠ¨æ›´æ–°ä¼šè¯ID
        IU->>+S: (ç”¨æˆ·è¿è¡Œ) POST /internal/start_id_capture
        S->>T: (WebSocket) å‘é€ 'activate_id_capture' æŒ‡ä»¤
        T->>L: (ç”¨æˆ·ç‚¹å‡»Retry) æ‹¦æˆªåˆ° fetch è¯·æ±‚
        T->>IU: (HTTP) å‘é€æ•èŽ·åˆ°çš„ID
        IU->>IU: æ›´æ–° config.jsonc
        IU-->>-T: ç¡®è®¤
    end

    alt æ­£å¸¸èŠå¤©æµç¨‹
        C->>+S: (ç”¨æˆ·èŠå¤©) /v1/chat/completions è¯·æ±‚
        S->>S: è½¬æ¢è¯·æ±‚ä¸º LMArena æ ¼å¼ (å¹¶ä»Ž models.json èŽ·å–æ¨¡åž‹ID)
        S->>T: (WebSocket) å‘é€åŒ…å« request_id å’Œè½½è·çš„æ¶ˆæ¯
        T->>L: (fetch) å‘é€çœŸå®žè¯·æ±‚åˆ° LMArena API
        L-->>T: (æµå¼)è¿”å›žæ¨¡åž‹å“åº”
        T->>S: (WebSocket) å°†å“åº”æ•°æ®å—ä¸€å—å—å‘å›ž
        S-->>-C: (æµå¼) è¿”å›ž OpenAI æ ¼å¼çš„å“åº”
    end

    alt æ–‡ç”Ÿå›¾æµç¨‹
        C->>+S: (ç”¨æˆ·è¯·æ±‚) /v1/images/generations è¯·æ±‚
        S->>S: (å¹¶è¡Œ) åˆ›å»º n ä¸ªä»»åŠ¡
        S->>T: (WebSocket) å‘é€ n ä¸ªåŒ…å« request_id çš„ä»»åŠ¡
        T->>L: (fetch) å‘é€ n ä¸ªçœŸå®žè¯·æ±‚
        L-->>T: (æµå¼) è¿”å›žå›¾ç‰‡ URL
        T->>S: (WebSocket) å°† URL å‘å›ž
        S-->>-C: (HTTP) è¿”å›žåŒ…å«æ‰€æœ‰ URL çš„ JSON å“åº”
    end
```

1.  **å»ºç«‹è¿žæŽ¥**: å½“ä½ åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ LMArena é¡µé¢æ—¶ï¼Œ**æ²¹çŒ´è„šæœ¬**ä¼šç«‹å³ä¸Ž**æœ¬åœ° FastAPI æœåŠ¡å™¨**å»ºç«‹ä¸€ä¸ªæŒä¹…çš„ **WebSocket è¿žæŽ¥**ã€‚
    > **æ³¨æ„**: å½“å‰æž¶æž„å‡å®šåªæœ‰ä¸€ä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µåœ¨å·¥ä½œã€‚å¦‚æžœæ‰“å¼€å¤šä¸ªé¡µé¢ï¼Œåªæœ‰æœ€åŽä¸€ä¸ªè¿žæŽ¥ä¼šç”Ÿæ•ˆã€‚
2.  **æŽ¥æ”¶è¯·æ±‚**: **OpenAI å®¢æˆ·ç«¯**å‘æœ¬åœ°æœåŠ¡å™¨å‘é€æ ‡å‡†çš„èŠå¤©è¯·æ±‚ï¼Œå¹¶åœ¨è¯·æ±‚ä½“ä¸­æŒ‡å®š `model` åç§°ã€‚
3.  **ä»»åŠ¡åˆ†å‘**: æœåŠ¡å™¨æŽ¥æ”¶åˆ°è¯·æ±‚åŽï¼Œä¼šæ ¹æ® `model` åç§°ä»Ž `models.json` æŸ¥æ‰¾å¯¹åº”çš„æ¨¡åž‹IDï¼Œç„¶åŽå°†è¯·æ±‚è½¬æ¢ä¸º LMArena éœ€è¦çš„æ ¼å¼ï¼Œå¹¶é™„ä¸Šä¸€ä¸ªå”¯ä¸€çš„è¯·æ±‚ ID (`request_id`)ï¼Œæœ€åŽé€šè¿‡ WebSocket å°†è¿™ä¸ªä»»åŠ¡å‘é€ç»™å·²è¿žæŽ¥çš„æ²¹çŒ´è„šæœ¬ã€‚
4.  **æ‰§è¡Œä¸Žå“åº”**: æ²¹çŒ´è„šæœ¬æ”¶åˆ°ä»»åŠ¡åŽï¼Œä¼šç›´æŽ¥å‘ LMArena çš„ API ç«¯ç‚¹å‘èµ· `fetch` è¯·æ±‚ã€‚å½“ LMArena è¿”å›žæµå¼å“åº”æ—¶ï¼Œæ²¹çŒ´è„šæœ¬ä¼šæ•èŽ·è¿™äº›æ•°æ®å—ï¼Œå¹¶å°†å®ƒä»¬ä¸€å—å—åœ°é€šè¿‡ WebSocket å‘å›žç»™æœ¬åœ°æœåŠ¡å™¨ã€‚
5.  **å“åº”ä¸­ç»§**: æœåŠ¡å™¨æ ¹æ®æ¯å—æ•°æ®é™„å¸¦çš„ `request_id`ï¼Œå°†å…¶æ”¾å…¥æ­£ç¡®çš„å“åº”é˜Ÿåˆ—ä¸­ï¼Œå¹¶å®žæ—¶åœ°å°†è¿™äº›æ•°æ®æµå¼ä¼ è¾“å›ž OpenAI å®¢æˆ·ç«¯ã€‚

## ðŸ“– API ç«¯ç‚¹

### èŽ·å–æ¨¡åž‹åˆ—è¡¨

*   **ç«¯ç‚¹**: `GET /v1/models`
*   **æè¿°**: è¿”å›žä¸€ä¸ªä¸Ž OpenAI å…¼å®¹çš„æ¨¡åž‹åˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨ä»Ž `models.json` æ–‡ä»¶ä¸­è¯»å–ã€‚

### èŠå¤©è¡¥å…¨

*   **ç«¯ç‚¹**: `POST /v1/chat/completions`
*   **æè¿°**: æŽ¥æ”¶æ ‡å‡†çš„ OpenAI èŠå¤©è¯·æ±‚ï¼Œæ”¯æŒæµå¼å’Œéžæµå¼å“åº”ã€‚

### å›¾åƒç”Ÿæˆ

*   **ç«¯ç‚¹**: `POST /v1/images/generations`
*   **æè¿°**: æŽ¥æ”¶æ ‡å‡†çš„ OpenAI æ–‡ç”Ÿå›¾è¯·æ±‚ï¼Œè¿”å›žç”Ÿæˆçš„å›¾ç‰‡ URLã€‚
*   **è¯·æ±‚ç¤ºä¾‹**:
    ```bash
    curl http://127.0.0.1:5102/v1/images/generations \
      -H "Content-Type: application/json" \
      -d '{
        "prompt": "A futuristic cityscape at sunset, neon lights, flying cars",
        "n": 2,
        "model": "dall-e-3"
      }'
    ```
*   **å“åº”ç¤ºä¾‹**:
    ```json
    {
      "created": 1677663338,
      "data": [
        {
          "url": "https://..."
        },
        {
          "url": "https://..."
        }
      ]
    }
    ```

## ðŸ“‚ æ–‡ä»¶ç»“æž„

```
.
â”œâ”€â”€ .gitignore                  # Git å¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ api_server.py               # æ ¸å¿ƒåŽç«¯æœåŠ¡ (FastAPI) ðŸ
â”œâ”€â”€ id_updater.py               # ä¸€é”®å¼ä¼šè¯IDæ›´æ–°è„šæœ¬ ðŸ†”
â”œâ”€â”€ model_updater.py              # æ‰‹åŠ¨æ¨¡åž‹åˆ—è¡¨æ›´æ–°è„šæœ¬ ðŸ“‹
â”œâ”€â”€ models.json                 # æ ¸å¿ƒæ¨¡åž‹æ˜ å°„è¡¨ (éœ€æ‰‹åŠ¨ç»´æŠ¤) ðŸ—ºï¸
â”œâ”€â”€ available_models.json       # å¯ç”¨æ¨¡åž‹å‚è€ƒåˆ—è¡¨ (è‡ªåŠ¨ç”Ÿæˆ) ðŸ“„
â”œâ”€â”€ model_endpoint_map.json     # [é«˜çº§] æ¨¡åž‹åˆ°ä¸“å±žä¼šè¯IDçš„æ˜ å°„è¡¨ ðŸŽ¯
â”œâ”€â”€ requirements.txt            # Python ä¾èµ–åŒ…åˆ—è¡¨ ðŸ“¦
â”œâ”€â”€ README.md                   # å°±æ˜¯ä½ çŽ°åœ¨æ­£åœ¨çœ‹çš„è¿™ä¸ªæ–‡ä»¶ ðŸ‘‹
â”œâ”€â”€ config.jsonc                # å…¨å±€åŠŸèƒ½é…ç½®æ–‡ä»¶ âš™ï¸
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ image_generation.py     # æ–‡ç”Ÿå›¾æ¨¡å— ðŸŽ¨
â”‚   â””â”€â”€ update_script.py        # è‡ªåŠ¨æ›´æ–°é€»è¾‘è„šæœ¬ ðŸ”„
â””â”€â”€ TampermonkeyScript/
    â””â”€â”€ LMArenaApiBridge.js     # å‰ç«¯è‡ªåŠ¨åŒ–æ²¹çŒ´è„šæœ¬ ðŸµ
```

**äº«å—åœ¨ LMArena çš„æ¨¡åž‹ä¸–ç•Œä¸­è‡ªç”±æŽ¢ç´¢çš„ä¹è¶£å§ï¼** ðŸ’–
>>>>>>> Incoming (Background Agent changes)
